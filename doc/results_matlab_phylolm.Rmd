---
title: "MATLAB and phylolm results"
author: "Lucas Nell"
date: "`r format(Sys.Date(), '%d %b %Y')`"
output:
  github_document:
    toc: true
    toc_depth: 1
---

```{r setup, include = FALSE, cache = FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_knit$set(root.dir = normalizePath(".."))
```


This script compares results with MATLAB code using measurement error as by 
[Ives et al. (2007)](https://doi.org/10.1080/10635150701313830)
to results from
[`phylolm`](https://doi.org/10.1093/sysbio/syu005).
All results are presented as `estimate [95% CI]`.

MATLABv1 refers to the first version that doesn't estimate phylogenetic signal 
(original name was `MERegPHYSIG 1Jul10`).

MATLABv2 refers to the next version that *does* estimate phylogenetic signal 
(original name was `MERegPHYSIGv2 29Jan17`).



```{r libraries}
# Packages needed for this script
suppressPackageStartupMessages({
    library(readr)
    library(dplyr)
    library(tidyr)
    library(stringr)
    library(purrr)
})
```


```{r parse_output}
# One parameter's info from a set of output lines
one_param <- function(.j, .lines, .X, .Y, .pos) {
    str <- sprintf('b%i = ', .j)
    repl_str <- sprintf('\\bb%i\\b|%%|=| |\\)', .j)
    values <- .lines %>%
        keep(~ str_detect(.x, str)) %>%
        str_replace_all(repl_str, '') %>%
        str_split('\\(|=|,', simplify = TRUE) %>%
        as.numeric
    return(data_frame(`Y` = .Y, `X` = .X[.j], pos = as.character(.pos),
                      value = values[1], lower = values[2], upper = values[4]))
}
# All info from one file
parse_output <- function(fn, .pos = NA, .version = NA) {
    if (grepl('.m$', fn)) {
        if (is.na(.version)) .version <- 'matlab'
        out_df <- read_lines(fn) %>% 
            # Remove blank and title lines
            discard(~ .x %in% c('', '%') | grepl('@|\\*', .x)) %>% 
            {map_dfr(which(grepl('~', .)), 
                     function(i) {
                         end <- keep(which(grepl('~', .)), ~ .x > i)[1]
                         end <- ifelse(is.na(end), length(.), end)
                         lines <- .[i:end]
                         params <- str_replace_all(.[i], '%| ', '') %>% 
                             str_split('\\+|~', simplify = TRUE) %>% 
                             as.character
                         Y <- params[1]
                         X <- params[-1]
                         map_dfr(1:length(X), one_param, lines, X, Y, .pos)
                     })} %>% 
            mutate(type = .version)
    } else {
        if (is.na(.version)) .version <- 'r'
        out_df <- read_csv(fn, col_types = 'cccddd') %>% 
            mutate(type = .version, X = ifelse(X == 'taxonBat', 'taxon', X))
    }
    out_df <- out_df %>% 
        mutate(pos = ifelse(is.na(pos), 'all', pos)) %>% 
        select(pos, type, Y, X, value, lower, upper)
    return(out_df)
}
# parse_output('matlab/output/distal.m', 'dist')
# parse_output('output/model_summaries.csv')
# parse_output('matlab/code_v1/output_spp.m', .version = 'matlab_v1')

summ_df <- pmap_dfr(list(
    c(sprintf('matlab/output/%s.m', c('distal', 'medial', 'proximal', 'spp_diet')),
      'output/models_summaries.csv', 'matlab/code_v1/output_spp.m'),
    c('dist', 'med', 'prox', NA, NA, NA),
    c(rep(NA, 5), 'matlab_v1')),
    parse_output
    ) %>%
    arrange(Y, type, X) %>% 
    gather('measure', 'estimate', value:upper) %>% 
    unite(temp, measure, type) %>% 
    spread(temp, estimate) %>% 
    filter(!is.na(value_matlab)) %>%  # removing log_sef ~ log_clear
    mutate(R = sprintf('%.4g [%.4g, %.4g]', value_r, lower_r, upper_r),
           MATLABv2 = sprintf('%.4g [%.4g, %.4g]', value_matlab, lower_matlab, 
                            upper_matlab),
           MATLABv1 = sprintf('%.4g [%.4g, %.4g]', value_matlab_v1, lower_matlab_v1, 
                            upper_matlab_v1)) %>% 
    arrange(pos, Y, X) %>% 
    select(pos, Y, X, R, MATLABv1, MATLABv2) %>% 
    nest(-pos)
```


# Positions combined

```{r spp_summs}
knitr::kable(filter(summ_df, pos == 'all')$data[[1]])
```


# Proximal

```{r prox_summs}
knitr::kable(filter(summ_df, pos == 'prox')$data[[1]] %>% select(-MATLABv1))
```


# Medial

```{r med_summs}
knitr::kable(filter(summ_df, pos == 'med')$data[[1]] %>% select(-MATLABv1))
```


# Distal

```{r dist_summs}
knitr::kable(filter(summ_df, pos == 'dist')$data[[1]] %>% select(-MATLABv1))
```




