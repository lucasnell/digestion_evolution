---
title: "Phylogenetic tree"
author: "Lucas Nell"
output:
  html_document:
    highlight: pygments
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE, comment = '', prompt = FALSE)
```


# Background

The paper by 
[Agnarsson et al. (2011)](http://dx.doi.org/10.1371/currents.RRN1212) used only one
mitochrondrial DNA gene and is the reason the Open Tree of Life (OTOL) version doesn't 
have a single resolved branch for *Myotis lucifugus*. A more recent paper by 
[Shi and Rabosky (2015)](http://onlinelibrary.wiley.com/doi/10.1111/evo.12681/abstract) 
uses multiple mitochondrial and nuclear genes and contains *M. lucifugus*.
This paper will be used to complete the tree.


# OTOL tree

I used the package `rotl` to interface with the Open Tree of Life (OTOL) to import trees
into R. [Here](https://cran.r-project.org/web/packages/rotl/vignettes/data_mashups.html)
is a guide on using it.

```{r, message = FALSE, warning = FALSE}
library(dplyr)
library(readr)
library(tidyr)
library(ggplot2)
library(ape)
library(rotl)
library(phylolm)
# library(vegan)
# library(lme4)
# library(pez)
# library(lmerTest)
```


Vector of species needed:

```{r}
sp_df <- 
'species,bat
Mus musculus,0
Rattus norvegicus,0
Thaptomys nigrita,0
Akodon montensis,0
Delomys sublineatus,0
Olygoryzomys nigripes,0
Sooretamys angouya,0
Euryoryzomys russatus,0
Peromyscus leucopus,0
Microtus pennsylvanicus,0
Artibeus lituratus,1
Carollia perspicillata,1
Desmodus rotundus,1
Molossus rufus,1
Molossus molossus,1
Eumops glaucinus,1
Tadarida brasiliensis,1
Myotis lucifugus,1
Eptesicus fuscus,1
' %>% 
    read_csv(.)
```


Searching for these species names in the OTOL database to make sure they exist there and 
to get their species IDs.

```{r}
taxon_search <- tnrs_match_names(names = sp_df$species, context_name = 'Mammals')
knitr::kable(taxon_search)
```


Making sure our names and IDs match up with those of the OTOL.

```{r}
sp_df$ott_name <- taxon_search$unique_name
sp_df$ott_id <- taxon_search$ott_id
```


We don't have good representation in published trees...

```{r}
hits <- lapply(sp_df$ott_id, studies_find_trees, property="ot:ottId", detailed = FALSE)
sapply(hits, function(x) sum(x[["n_matched_trees"]]))
```

So I'm creating a tree from 
the synthesis OTOL tree using species, except replacing *M. lucifugus* with 
*M. lucifugus lucifugus*. Using *M. lucifugus lucifugus* allows me to see where
*M. lucifugus* will later be placed.

```{r}
tr <- tol_induced_subtree(
    ott_ids = c(sp_df$ott_id[sp_df$species != 'Myotis lucifugus'],
                tnrs_match_names(names = 'Myotis lucifugus lucifugus', 
                                 context_name = 'Mammals')$ott_id))

tr$tip.label <- strip_ott_ids(tr$tip.label, remove_underscores=TRUE)
plot(tr, no.margin = TRUE, label.offset = 0.5); nodelabels(); tiplabels()
```





# Including *M. lucifugus* from Shi and Rabosky (2015)

You can download the tree by 
[Shi and Rabosky (2015)](http://onlinelibrary.wiley.com/doi/10.1111/evo.12681/abstract)
[(OTOL link)](https://tree.opentreeoflife.org/curator/study/view/ot_254)
and adjust its tip labels to remove underscores as such:

```{r}
shi <- get_study(study_id = 'ot_254', object_format = 'phylo')
shi$tip.label <- gsub('_', ' ', shi$tip.label)
```


```{r}
# Rooting tree
# root(shi, )
# Removing all tips except those for *Eptesicus fuscus* and *Myotis lucifugus*
shi_filt <- drop.tip(
    shi, 
    tip = shi$tip.label[!shi$tip.label %in% c('Eptesicus fuscus', 'Myotis lucifugus', 
                                              'Mus musculus')])
# shi_filt <- root(shi_filt, 'Mus musculus')

plot(shi_filt); nodelabels(); tiplabels()
```


```{r}
is.rooted(drop.tip(
    shi, 
    tip = shi$tip.label[!shi$tip.label %in% c('Mus musculus', 'Eptesicus fuscus', 
                                              'Myotis lucifugus')]))
nodelabels(); tiplabels()
```



```{r}
# Combining them
# ?bind.tree

# final_tr <- bind.tree(tr, shi_filt, where = 23)
# plot(final_tr)
```



Current plan:
1. Remove bats from `shi` that are present in `tr`
2. Combine them
3. Remove all species not in `sp_df$species`
