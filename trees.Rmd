---
title: "Phylogenetic tree"
author: "Lucas Nell"
output: html
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code 
within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your 
cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE, comment = '', prompt = FALSE)
```


# Background

The paper by 
[Agnarsson et al. (2011)](http://dx.doi.org/10.1371/currents.RRN1212) used only one
mitochrondrial DNA gene and is the reason the Open Tree of Life (OTL) version doesn't 
have a single resolved branch for *Myotis lucifugus*. A more recent paper by 
[Shi and Rabosky (2015)](http://onlinelibrary.wiley.com/doi/10.1111/evo.12681/abstract) 
uses multiple mitochondrial and nuclear genes and contains *M. lucifugus*.
This paper will be used to complete the tree.


# OTL tree

I used the package `rotl` to interface with the Open Tree of Life (OTL) to import trees
into R. [Here](https://cran.r-project.org/web/packages/rotl/vignettes/data_mashups.html)
is a guide on using it.

```{r, message = FALSE, warning = FALSE}
library(dplyr)
library(readr)
library(tidyr)
library(ggplot2)
library(ape)
library(rotl)
library(phylolm)
# library(vegan)
# library(lme4)
# library(pez)
# library(lmerTest)
```


Vector of species needed:

```{r}
sp_df <- 
'Akodon montensis
Delomys sublineatus
Euryoryzomys russatus
Rattus norvegicus
Olygoryzomys nigripes
Sooretamys angouya
Thaptomys nigrita
Peromyscus leucopus
Mus musculus
Microtus pennsylvanicus
Molossus rufus
Myotis lucifugus
Molossus molossus
Eumops glaucinus
Desmodus rotundus
Carollia perspicillata
Artibeus lituratus
Tadarida brasiliensis
Eptesicus fuscus
' %>% 
    read_csv(., col_names = 'species')
```


Searching for these species names in the OTL database to make sure they exist there and 
to get their species IDs.

```{r}
taxon_search <- tnrs_match_names(names = sp_df$species, context_name = 'Mammals')
knitr::kable(taxon_search)
```


Making sure our names and IDs match up with those of the OTL.

```{r}
sp_df$ott_name <- taxon_search$unique_name
sp_df$ott_id <- taxon_search$ott_id
```


Since we don't have good representation in published trees, I'm creating a tree from 
all but *M. lucifugus* using the synthesis tree.

```{r}
hits <- lapply(sp_df$ott_id, studies_find_trees, property="ot:ottId", detailed = FALSE)
sapply(hits, function(x) sum(x[["n_matched_trees"]]))

tr <- tol_induced_subtree(ott_ids=sp_df$ott_id[sp_df$species != 'Myotis lucifugus'])
tr$tip.label <- strip_ott_ids(tr$tip.label, remove_underscores=TRUE)
plot(tr); nodelabels()
```





# Including *M. lucifugus* from Shi and Rabosky (2015)

In `bash` (in my case, "Terminal" in macOS), you can download the tree by 
[Shi and Rabosky (2015)](http://onlinelibrary.wiley.com/doi/10.1111/evo.12681/abstract)
as such:

```{bash, eval = FALSE}
wget "http://purl.org/phylo/treebase/phylows/tree/TB2:Tr87680?format=nexus"
mv "TB2:Tr87680?format=nexus" Shi_Rabosky_2015.nex
```



```{r, eval = FALSE}
shi <- read.nexus('Shi_Rabosky_2015.nex')
shi$tip.label <- gsub('_', ' ', shi$tip.label)
# pdf('Shi_tree.pdf', width = 6, height = 12)
plot(shi, cex = 0.1, edge.width = 0.25)
# dev.off()
# ?bind.tree

# Non-bat species present in tree:
# c('Sorex araneus', 'Mus musculus', 'Canis lupus')

shi_filt <- drop.tip(shi, tip = shi$tip.label[!shi$tip.label %in% tr$tip.label])
plot(shi_filt); nodelabels()
```


Current plan:
1. Remove bats from `shi` that are present in `tr`
2. Combine them
3. Remove all species not in `sp_df$species`
